apiVersion: batch/v1
kind: Job
metadata:
  name: osdu-postgres-initdb
  namespace: osdu-data
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation,HookSucceeded
    argocd.argoproj.io/sync-wave: "1"
spec:
  backoffLimit: 3
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: initdb
          image: postgres:16-alpine
          imagePullPolicy: IfNotPresent
          envFrom:
            - secretRef:
                name: osdu-postgres-secret
          command: ["sh","-c"]
          args:
            - |-
              set -euo pipefail

              echo "Waiting for Postgres..."
              export PGPASSWORD="${POSTGRES_PASSWORD:?missing POSTGRES_PASSWORD}"
              until pg_isready -h osdu-postgres -p 5432 -U "${POSTGRES_USER}" -d postgres; do
                sleep 2
              done
              echo "Postgres is ready."

              DBS="osdu entitlements legal partition storage registry file schema"
              for db in $DBS; do
                echo "Ensure database: $db"
                EXISTS="$(psql -h osdu-postgres -p 5432 -U "${POSTGRES_USER}" -d postgres -tAc \
                  "SELECT 1 FROM pg_database WHERE datname='${db}'")"
                if [ "${EXISTS}" != "1" ]; then
                  psql -h osdu-postgres -p 5432 -U "${POSTGRES_USER}" -d postgres -v ON_ERROR_STOP=1 \
                    -c "CREATE DATABASE \"${db}\";"
                fi
              done

              echo "Initdb done."

