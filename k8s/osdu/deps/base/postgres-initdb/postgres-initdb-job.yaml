apiVersion: batch/v1
kind: Job
metadata:
  name: osdu-postgres-initdb
  namespace: osdu-data
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation,HookSucceeded
    argocd.argoproj.io/sync-wave: "1"
spec:
  backoffLimit: 3
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: initdb
          image: postgres:16-alpine
          imagePullPolicy: IfNotPresent
          envFrom:
            - secretRef:
                name: osdu-postgres-secret
          command: ["sh", "-c"]
          args:
            - |-
              set -euo pipefail

              echo "Waiting for Postgres..."
              # Dùng biến môi trường an toàn thay vì hardcode
              export PGPASSWORD="${POSTGRES_PASSWORD:-}"
              
              # Chờ DB sẵn sàng
              until pg_isready -h osdu-postgres -p 5432 -U "${POSTGRES_USER}"; do
                echo "Waiting for postgres connection..."
                sleep 2
              done
              echo "Postgres is ready."

              DBS="osdu entitlements legal partition storage registry file schema notification"
              
              for db in $DBS; do
                echo "Ensure database: $db"
                # Kiểm tra DB tồn tại chưa (trả về 1 nếu có)
                EXISTS="$(psql -h osdu-postgres -p 5432 -U "${POSTGRES_USER}" -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname='${db}'")"
                
                if [ "${EXISTS}" != "1" ]; then
                  echo "Creating database: $db"
                  psql -h osdu-postgres -p 5432 -U "${POSTGRES_USER}" -d postgres -c "CREATE DATABASE \"${db}\";"
                else
                  echo "Database $db already exists."
                fi
              done

              echo "Initdb done."
